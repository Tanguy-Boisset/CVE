# CVE-2024-54852

## Summary

| ID                    | CVE-2024-54852                                           |
|-----------------------|----------------------------------------------------------|
| **Type**              | LDAP Injection                                           |
| **Title**             | LDAP Injection on login form                             |
| **Product impacted**  | Teedy                                                    |
| **Impacted version**  | Versions between 1.9 and 1.12 included                   |
| **CVSS Score**        | 8.2                                                      |
| **Author**            | Sopalinge                                                |

## Description

When LDAP connection is activated on Teedy in versions 1.12 or prior, the username field of the login form is vulnerable to LDAP injection. Due to improper sanitization of user input, an unauthenticated attacker is then able to perform various malicious actions, such as creating arbitrary accounts and spraying passwords.

LDAP connection is **not** enabled by default. An administrator has to activate and configure it beforehand by defining an LDAP query that the application will perform to authenticate users. It has to contain a `USERNAME` placeholder, e.g. `(&(objectclass=inetOrgPerson)(uid=USERNAME))`.

The root cause of the vulnerability lies in the `authenticate` method of the `docs-core/src/main/java/com/sismics/docs/core/util/authentication/LdapAuthenticationHandler.java` file of Teedy :
```
public User authenticate(String username, String password) {
    ...
    ConfigUtil.getConfigStringValue(ConfigType.LDAP_FILTER).replace("USERNAME", username), SearchScope.SUBTREE);
    ...
}
```
The `USERNAME` placeholder is directly replaced in the query by the user input `username` variable. The LDAP query is then executed, which allows an attacker to modify its execution flow and perform various malicious actions.

## Impact

The impact can vary depending on the LDAP query defined for the LDAP connection to Teedy. However, various malicious actions can be performed, such as :
 - Unrestricted account creation
 - Password spraying
 - ...

Next section goes into details of these two examples.

## Proof of concept

For this part, it is assumed the two following :
 - The LDAP query is : `(&(objectclass=inetOrgPerson)(uid=USERNAME))`
 - The attacker knows one LDAP account `jdoe:password`

### Unrestricted account creation
An attacker can inject the payload `jdoe))((|(uid=1` into the username field of the login form and input the right password for the `jdoe` account. The LDAP query then becomes `(&(objectclass=inetOrgPerson)(uid=jdoe))((|(uid=1))` which yields true as the password is correct.\
Because the account `jdoe))((|(uid=1` does not exist in the Teedy database, it is created.

Therefore, an attacker can create as many accounts as he wants as long as he knows at least one valid LDAP account, by inputting crafted usernames like :
```
jdoe))((|(uid=1
jdoe))((|(uid=2
jdoe))((|(uid=3
...
```

As a side effect, because the Teedy API does not support special characters in usernames, most profile methods for these accounts will break. That means that an administrator will not be able to delete these accounts through the web interface, whereas most functionnalities will remain functional for the attacker.

### Password spraying
An attacker can perform password spraying onto the LDAP. It is indeed possible to inject the following payload into the username field of the login form `*)(userPassword=hello123` and the same password guess in the password field. The LDAP query then becomes `(&(objectclass=inetOrgPerson)(uid=*)(userPassword=hello123))` which will return true if an LDAP account with the password `hello123` exists. In that case, the login is validated and the attacker will be connected to Teedy with the newly created `*)(userPassword=hello123` user. Otherwise, the login form will yield an error.

It is therefore possible to spray a list of common passwords with only one LDAP request by password. Once a valid password is found, it is possible to find the user(s) that have it by finding the username character by character and inputting the newly found password into the password field of the Teedy login form. The bruteforce requests would look like the following :
```
# If you have found 'hello123' as a valid password, use it in the password field of the login form
username: a*)(userPassword=hello123     # Error
username: b*)(userPassword=hello123     # Error
username: c*)(userPassword=hello123     # OK => username starts with 'c'
...

username: ca*)(userPassword=hello123    # OK => username starts with 'ca'
username: cb*)(userPassword=hello123    # Error
username: cc*)(userPassword=hello123    # Error
...

username: caa*)(userPassword=hello123   # Error
username: cab*)(userPassword=hello123   # OK => username starts with 'cab'
username: cac*)(userPassword=hello123   # Error
...

# And so on, until you find the whole username
```

## Timeline

- 23/10/2024 : Vulnerability discovered
- 24/10/2024 : Vendor contacted
- 12/12/2024 : CVE ID attributed
- 28/01/2024 : CVE publicly disclosed


## References

- [Teedy source code](https://github.com/sismics/docs)
